"""
ü§ñ TELEGRAM –ë–û–¢ –î–õ–Ø –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê –õ–û–ì–û–í
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
"""

import asyncio
import random
import logging
from datetime import datetime
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
import aiofiles

# ================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# ================================



TOKEN = "8404442051:AAEsXWPei9TgN9eBVAG6zzkpH3BEYeELpFo"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π —Ç–æ–∫–µ–Ω!
CHAT_ID = "5861689807"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π chat_id

# –£—Ä–æ–≤–Ω–∏ —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ –æ—à–∏–±–æ–∫
ERROR_LEVELS = {
    "CRITICAL": "üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø",
    "ERROR": "üî¥ –û–®–ò–ë–ö–ê",
    "WARNING": "üü° –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï",
    "INFO": "üîµ –ò–ù–§–û–†–ú–ê–¶–ò–Ø"
}

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = Bot(token=TOKEN)
dp = Dispatcher()


# ================================
# –ì–ï–ù–ï–†–ê–¢–û–† –¢–ï–°–¢–û–í–´–• –õ–û–ì–û–í
# ================================

async def generate_test_logs():
    """–°–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –ª–æ–≥–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏"""

    log_messages = [
        "[ERROR] Database connection failed: Connection refused",
        "[WARNING] High memory usage: 85% of RAM",
        "[INFO] User 'alex' logged in successfully",
        "[CRITICAL] Server is out of memory! Killing process",
        "[ERROR] Payment service timeout after 30s",
        "[INFO] Backup completed successfully",
        "[WARNING] Disk space is running low: 15% free",
        "[ERROR] Failed to send email: SMTP error",
        "[INFO] System started at 2024-01-15 10:00:00",
        "[CRITICAL] Database corruption detected!"
    ]

    # –°–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    message = random.choice(log_messages)
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –ª–æ–≥–∞
    log_line = f"{timestamp} - {message}\n"

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ —Ñ–∞–π–ª
    async with aiofiles.open('test.log', 'a') as f:
        await f.write(log_line)

    return log_line


# ================================
# –ê–ù–ê–õ–ò–ó–ê–¢–û–† –õ–û–ì–û–í
# ================================

def analyze_log_line(log_line):
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –ª–æ–≥–∞ –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å"""

    if "[CRITICAL]" in log_line:
        return "CRITICAL", "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Å–∏—Å—Ç–µ–º–µ"
    elif "[ERROR]" in log_line:
        return "ERROR", "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞"
    elif "[WARNING]" in log_line:
        return "WARNING", "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ"
    elif "[INFO]" in log_line:
        return "INFO", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
    else:
        return "UNKNOWN", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ª–æ–≥–∞"


# ================================
# –û–¢–ü–†–ê–í–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –í TELEGRAM
# ================================

async def send_telegram_alert(log_line, level, description):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫—Ä–∞—Å–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram"""

    emoji = {
        "CRITICAL": "üî¥",
        "ERROR": "üî¥",
        "WARNING": "üü°",
        "INFO": "üîµ"
    }.get(level, "‚ö™")

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    message = f"""
{emoji} *–õ–û–ì-–ú–û–ù–ò–¢–û–†: {ERROR_LEVELS.get(level, level)}*

üìÖ *–í—Ä–µ–º—è:* {datetime.now().strftime('%H:%M:%S')}
üìä *–£—Ä–æ–≤–µ–Ω—å:* {level}
üìù *–û–ø–∏—Å–∞–Ω–∏–µ:* {description}

```{log_line[:200]}```

#–ª–æ–≥ #{level.lower()}
"""

    try:
        await bot.send_message(
            chat_id=CHAT_ID,
            text=message,
            parse_mode="Markdown"
        )
        print(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {level}")
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
        return False


# ================================
# –ú–û–ù–ò–¢–û–†–ò–ù–ì –§–ê–ô–õ–ê –õ–û–ì–û–í
# ================================

async def monitor_logs():
    """–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç —Ñ–∞–π–ª –ª–æ–≥–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""

    print("üîç –ù–∞—á–∏–Ω–∞—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤...")
    print("üìÅ –ß–∏—Ç–∞—é —Ñ–∞–π–ª: test.log")
    print("ü§ñ –ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω! –û–∂–∏–¥–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram...\n")

    try:
        async with aiofiles.open('test.log', 'r') as f:
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞
            await f.seek(0, 2)

            while True:
                # –ß–∏—Ç–∞–µ–º –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏
                line = await f.readline()

                if line:
                    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–≥
                    level, description = analyze_log_line(line)

                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –æ—à–∏–±–æ–∫ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
                    if level in ["CRITICAL", "ERROR", "WARNING"]:
                        await send_telegram_alert(line, level, description)

                # –ñ–¥–µ–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
                await asyncio.sleep(2)

    except FileNotFoundError:
        print("‚ö†Ô∏è –§–∞–π–ª test.log –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—é...")
        async with aiofiles.open('test.log', 'w') as f:
            await f.write("# –§–∞–π–ª –ª–æ–≥–æ–≤ —Å–æ–∑–¥–∞–Ω\n")


# ================================
# –ö–û–ú–ê–ù–î–´ TELEGRAM –ë–û–¢–ê
# ================================

@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    """–ö–æ–º–∞–Ω–¥–∞ /start - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ"""

    welcome_text = """
ü§ñ *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Log Monitor Bot!*

–Ø –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä—é –ª–æ–≥–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö.

*–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
/start - —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
/status - —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
/test - —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –æ—à–∏–±–∫—É
/logs - –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
/help - –ø–æ–º–æ—â—å

–ë–æ—Ç —É–∂–µ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç —Ñ–∞–π–ª –ª–æ–≥–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏!
"""

    await message.answer(welcome_text, parse_mode="Markdown")


@dp.message(Command("status"))
async def cmd_status(message: types.Message):
    """–ö–æ–º–∞–Ω–¥–∞ /status - —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã"""

    status_text = """
üìä *–°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´*

‚úÖ –ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤: –í–ö–õ–Æ–ß–ï–ù
üìÅ –§–∞–π–ª –ª–æ–≥–æ–≤: test.log
‚è± –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —Å–µ–π—á–∞—Å

*–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –±–æ—Ç:*
1. –ß–∏—Ç–∞–µ—Ç –ª–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
2. –ù–∞—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
4. –†–∞–±–æ—Ç–∞–µ—Ç 24/7 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
"""

    await message.answer(status_text, parse_mode="Markdown")


@dp.message(Command("test"))
async def cmd_test(message: types.Message):
    """–ö–æ–º–∞–Ω–¥–∞ /test - —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –æ—à–∏–±–∫—É"""

    log_line = await generate_test_logs()
    level, description = analyze_log_line(log_line)

    response = f"""
üß™ *–¢–ï–°–¢–û–í–ê–Ø –û–®–ò–ë–ö–ê –°–û–ó–î–ê–ù–ê*

–î–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –ª–æ–≥–∏:

–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
"""

    await message.answer(response, parse_mode="Markdown")

@dp.message(Command("logs"))
async def cmd_logs(message: types.Message):
    """–ö–æ–º–∞–Ω–¥–∞ /logs - –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏"""

    try:
        async with aiofiles.open('test.log', 'r') as f:
            lines = await f.readlines()
            last_lines = lines[-10:] if len(lines) > 10 else lines

            if last_lines:
                logs_text = "".join(last_lines)
                response = f"""
üìú *–ü–û–°–õ–ï–î–ù–ò–ï 10 –õ–û–ì–û–í:*
–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {len(lines)}
"""
            else:
                response = "üì≠ –§–∞–π–ª –ª–æ–≥–æ–≤ –ø—É—Å—Ç"

    except FileNotFoundError:
        response = "‚ö†Ô∏è –§–∞–π–ª –ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω"

    await message.answer(response, parse_mode="Markdown")

@dp.message(Command("help"))
async def cmd_help(message: types.Message):
    """–ö–æ–º–∞–Ω–¥–∞ /help - –ø–æ–º–æ—â—å"""

    help_text = """
‚ùì *–ü–û–ú–û–©–¨ –ü–û –ö–û–ú–ê–ù–î–ê–ú*

/start - –Ω–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º
/status - —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
/test - —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –æ—à–∏–±–∫—É
/logs - –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
/help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

*–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:*
1. –ë–æ—Ç —á–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª test.log
2. –ù–∞—Ö–æ–¥–∏—Ç —Å—Ç—Ä–æ–∫–∏ —Å [ERROR], [WARNING], [CRITICAL]
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —ç—Ç–æ—Ç —á–∞—Ç
4. –í—Å—ë –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!

*–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:*
–ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏—Ç–µ –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª test.log –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
`[–£–†–û–í–ï–ù–¨] –°–æ–æ–±—â–µ–Ω–∏–µ`
"""

    await message.answer(help_text, parse_mode="Markdown")

# ================================
# –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
# ================================

async def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"""

    print("="*50)
    print("ü§ñ TELEGRAM –ë–û–¢ –î–õ–Ø –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê –õ–û–ì–û–í")
    print("="*50)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
    if TOKEN == "–í–ê–®_–¢–û–ö–ï–ù_–ó–î–ï–°–¨":
        print("‚ùå –û–®–ò–ë–ö–ê: –ó–∞–º–µ–Ω–∏—Ç–µ TOKEN –Ω–∞ —Å–≤–æ–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞!")
        print("1. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather")
        print("2. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω")
        print("3. –í—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ —Ñ–∞–π–ª–µ bot.py")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º chat_id
    if CHAT_ID == "–í–ê–®_CHAT_ID":
        print("‚ùå –û–®–ò–ë–ö–ê: –ó–∞–º–µ–Ω–∏—Ç–µ CHAT_ID –Ω–∞ —Å–≤–æ–π chat_id!")
        print("1. –ù–∞–ø–∏—à–∏—Ç–µ @userinfobot –≤ Telegram")
        print("2. –ü–æ–ª—É—á–∏—Ç–µ —Å–≤–æ–π chat_id")
        print("3. –í—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ —Ñ–∞–π–ª–µ bot.py")
        return

    # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–≤–µ –∑–∞–¥–∞—á–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:
    # 1. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥ Telegram
    # 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤
    print("\nüöÄ –ó–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞...")

    # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ª–æ–≥–æ–≤
    monitor_task = asyncio.create_task(monitor_logs())

    # –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ—Å—Ç–æ–≤—ã—Ö –ª–æ–≥–æ–≤ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
    async def generate_periodically():
        while True:
            await asyncio.sleep(10)
            await generate_test_logs()

    generator_task = asyncio.create_task(generate_periodically())

    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –ü–∏—à–∏—Ç–µ /start –≤ Telegram")

    await dp.start_polling(bot)

# ================================
# –ó–ê–ü–£–°–ö –ü–†–û–ì–†–ê–ú–ú–´
# ================================

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n\nüëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

